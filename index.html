<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>paint??</title>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://unpkg.com/aframe-text-geometry-component/dist/aframe-text-geometry-component.min.js"></script>
    <script src="src/glow.js"></script>
    <script type="text/javascript">
      /* jshint esversion: 6 */
      AFRAME.registerComponent('current-color-display', {
        init: function() {
          var system = document.querySelector('a-scene').systems['color-select'];
          system.registerCurrentColorDisplay(this.el);
        }
      });

      AFRAME.registerSystem('color-select', {
        init: function() {
          this.currentColor = 'white'; // TODO: not great sanitizing haha, could also accept "#ff0000" for example
          this.currentColorDisplay = null;
        },

        // Current color display shows the current paintbrush color
        registerCurrentColorDisplay(currentColorDisplay) {
          this.currentColorDisplay = currentColorDisplay;
        },

        // Set the current paintbrush color
        setCurrentColor(color) {
          // TODO: need to ensure that this.currentColorDisplay is initialized
          this.currentColor = color;
          this.currentColorDisplay.setAttribute("color", color);
        },
      });

      AFRAME.registerComponent('color-select', {
        init: function() {
          var el = this.el;
          var system = this.system;
          el.addEventListener('click', function (event) {
            console.log('I was clicked at: ', event.detail.intersection.point);
            system.setCurrentColor(el.getAttribute("color"));
          });
        }
      });

      AFRAME.registerComponent('colorable', {
        init: function() {
          var el = this.el;
          el.addEventListener('click', function(event) {
            var currentColor = document.querySelector('a-scene').systems['color-select'].currentColor;
            el.setAttribute("color", currentColor);
          });
        },
      });

      AFRAME.registerComponent('mosaic-grid', {
        init: function() {
          var rows = 10;
          var cols = 10;
          var height = 0.2;
          var width = 0.2;
          var depth = 4;
          for (let i = 0; i < rows; i++) {
            for (let j = 0; j < cols; j++) {
              var mosaicTile = document.createElement('a-plane');
              mosaicTile.setAttribute('width', width);
              mosaicTile.setAttribute('height', height);
              var worldLocations = this.coordinateToWorldLocation(i, j, rows, cols, height, width, depth);
              mosaicTile.setAttribute('position', worldLocations);
              var randomColor = Math.floor(Math.random()*16777215).toString(16);
              mosaicTile.setAttribute('color', '#' + randomColor);
              mosaicTile.setAttribute('colorable', '');
              this.el.appendChild(mosaicTile);
            }
          }
        },

        // Returns string "x y z" that can be plugged directly into position. Assumes centered at 0, 0.
        coordinateToWorldLocation: function(row, col, rows, cols, height, width, depth) {
          var leftmostWorldX = -1 * cols / 2 * width;
          var topmostWorldY = rows / 2 * height;
          var x = leftmostWorldX + width * col + width / 2;
          var y = topmostWorldY - height * row - height / 2;
          return x + " " + y + " -" + depth;
        }
      });

      AFRAME.registerComponent('palette', {
        // makes the palette face the origin so that the plane of the color circles is perfectly lined up when the player looks at it. This requires a rotation about the x-axis.
        init: function() {
          var yPos = this.el.getAttribute('position').y;
          var zPos = this.el.getAttribute('position').z;
          var xRotation = -Math.atan(yPos / zPos) * 180 / Math.PI; // Aframe uses degrees
          this.el.setAttribute('rotation', xRotation + " 0 0");
        }
      });

      AFRAME.registerComponent('pulsing-glow', {
        init: function() {
          this.el.setAttribute('expanding', false);
        },

        tick: function() {
          var r = Number(this.el.getAttribute('glow').scale);
          if (r <= 1.01) {
            this.el.setAttribute('expanding', true);
          }
          else if (r >= 2) {
            this.el.setAttribute('expanding', false);
          }
          // Ah, Javascript, you and your types >:)
          if (this.el.getAttribute('expanding') == 'true') {
            r += 0.05;
          }
          else {
            r -= 0.01;
          }
          this.el.setAttribute('glow', 'scale:' + r);
        }
      });
    </script>
</head>
<body>
  <a-scene id="scene">
    <a-sky color="black"></a-sky>
    <a-camera look-controls position="0 0 0" wasd-controls="fly:true">
      <a-cursor></a-cursor>
      <a-entity position="0.5 0.5 -1">
        <a-entity position="0.374 0.105 0" text="value: Current color; color: black"></a-entity> <!-- no clue why this positioning puts it above the color circle but it does -->
        <a-entity>
          <a-circle id="current-color-circle" radius="0.05" current-color-display></a-circle>
          <a-ring id="current-color-ring" radius-inner="0.05" radius-outer="0.055" color="black"></a-ring>
        </a-entity>
      </a-entity>
    </a-camera>
    <!-- <a-sphere color="yellow" position="0 0 0" radius="10" material="side: double"></a-sphere> -->
    <a-entity position="0 -2 -4" palette>
      <a-circle color="red" position="-1 0 0" radius="0.4" color-select side="double"></a-circle>
      <a-circle color="green" position="0 0 0" radius="0.4" color-select side="double"></a-circle>
      <a-circle color="blue" position="1 0 0" radius="0.4" color-select side="double"></a-circle>
    </a-entity>
    <a-sphere glow="c:0.2; p:1.4;scale:3" position="1 0.5 -3" radius="0.05"></a-sphere>
    <a-sphere glow="c:0.2; p:1.4;scale:3" position="-1 0.5 -3" radius="0.05"></a-sphere>
    <a-sphere glow="c:0.2; p:1.4;scale:3" position="1 -0.5 -3" radius="0.05"></a-sphere>
    <a-sphere glow="c:0.2; p:1.4;scale:3" position="-1 -0.5 -3" radius="0.05" pulsing-glow></a-sphere>
    <a-entity mosaic-grid></a-entity>
  </a-scene>
</body>
</html>
